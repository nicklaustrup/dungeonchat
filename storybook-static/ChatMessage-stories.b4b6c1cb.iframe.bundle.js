"use strict";(self.webpackChunkdungeonchat=self.webpackChunkdungeonchat||[]).push([[662],{"./src/components/ChatInput/EmojiMenu.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Ay:()=>__WEBPACK_DEFAULT_EXPORT__});var C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/objectSpread2.js"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/index.js"),react_dom__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/react-dom/index.js"),emoji_picker_react__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/emoji-picker-react/dist/emoji-picker-react.esm.js"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/react/jsx-runtime.js");let externalOpen,mountNode;function EmojiMenuSingleton(){const[state,setState]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)({visible:!1,anchorRect:null,onSelect:null,onClose:null}),stateRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(state);(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{stateRef.current=state},[state]);const panelRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(null),[panelStyle,setPanelStyle]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(null),close=(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)(()=>{setState(s=>(0,C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__.A)((0,C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__.A)({},s),{},{visible:!1}));const latest=stateRef.current;latest.onClose&&latest.onClose()},[]),open=(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)(opts=>{setState({visible:!0,anchorRect:opts.anchorRect||null,onSelect:opts.onSelect||null,onClose:opts.onClose||null})},[]);(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{externalOpen=open},[open]),(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{if(!state.visible)return;const onKey=e=>{"Escape"===e.key&&close()},onPointer=e=>{const panel=panelRef.current;panel&&!panel.contains(e.target)&&close()};return document.addEventListener("keydown",onKey,!0),document.addEventListener("pointerdown",onPointer,!0),()=>{document.removeEventListener("keydown",onKey,!0),document.removeEventListener("pointerdown",onPointer,!0)}},[state.visible,close]),(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{if(!state.visible)return void setPanelStyle(null);if(!panelRef.current||!state.anchorRect)return;const anchor=state.anchorRect,panelRect=panelRef.current.getBoundingClientRect(),bounds=(document.querySelector(".App section")||document.querySelector(".App")||document.body).getBoundingClientRect();let top=anchor.top-panelRect.height-6,placeAbove=!0;top<bounds.top+4&&(top=anchor.bottom+6,placeAbove=!1);let left=anchor.left;if(left+panelRect.width>bounds.right-4&&(left=bounds.right-panelRect.width-4),left<bounds.left+4&&(left=bounds.left+4),!placeAbove&&top+panelRect.height>bounds.bottom-4){const retryTop=anchor.top-panelRect.height-6;retryTop>=bounds.top+4&&(top=retryTop,placeAbove=!0)}setPanelStyle({top:Math.round(top),left:Math.round(left),position:"fixed",transform:"none","--emoji-placement":placeAbove?"above":"below"})},[state.visible,state.anchorRect]);const theme=document.body.classList.contains("light-theme")||document.querySelector(".App.light-theme")?"light":"dark";if(!state.visible)return null;const style=panelStyle||(state.anchorRect?{position:"fixed",top:state.anchorRect.bottom+8,left:state.anchorRect.left,opacity:0}:{top:"50%",left:"50%",transform:"translate(-50%, -50%)"});return(0,react_dom__WEBPACK_IMPORTED_MODULE_2__.createPortal)((0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{ref:panelRef,className:"emoji-picker-portal",style:(0,C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__.A)({zIndex:1600},style),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)(emoji_picker_react__WEBPACK_IMPORTED_MODULE_3__.Ay,{onEmojiClick:emojiData=>{state.onSelect&&state.onSelect(emojiData),close()},autoFocusSearch:!0,theme})}),mountNode)}EmojiMenuSingleton.open=options=>{externalOpen?externalOpen(options):setTimeout(()=>externalOpen&&externalOpen(options),0)};const __WEBPACK_DEFAULT_EXPORT__={open:options=>EmojiMenuSingleton.open(options)}},"./src/stories/ChatMessage.stories.jsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DeletedMessage:()=>DeletedMessage,EditedMessage:()=>EditedMessage,ImageMessage:()=>ImageMessage,MenuOpenState:()=>MenuOpenState,NoMetaGrouped:()=>NoMetaGrouped,ReplyMessage:()=>ReplyMessage,TextReceived:()=>TextReceived,TextSent:()=>TextSent,WithReactions:()=>WithReactions,__namedExportsOrder:()=>__namedExportsOrder,default:()=>ChatMessage_stories});var objectSpread2=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/objectSpread2.js"),react=__webpack_require__("./node_modules/react/index.js"),index_esm=__webpack_require__("./node_modules/firebase/firestore/dist/esm/index.esm.js"),FirebaseContext=(__webpack_require__("./src/components/ChatRoom/ChatMessage.css"),__webpack_require__("./src/components/ChatRoom/ChatMessage.menu.css"),__webpack_require__("./src/components/ChatRoom/ChatMessage.reactions.css"),__webpack_require__("./src/components/ChatRoom/ChatMessage.modals.css"),__webpack_require__("./src/components/ChatRoom/ChatMessage.tooltips.css"),__webpack_require__("./src/services/FirebaseContext.js"));const avatarCache=new Map;function getFallbackAvatar(_ref){let{uid,displayName,size=64}=_ref;const key="".concat(displayName||uid||"user","-").concat(size);if(avatarCache.has(key))return avatarCache.get(key);const safeName=encodeURIComponent(displayName||uid||"User"),url="https://ui-avatars.com/api/?name=".concat(safeName,"&background=0d8abc&color=fff&size=").concat(size);return avatarCache.set(key,url),url}var PresenceContext=__webpack_require__("./src/services/PresenceContext.js"),EmojiMenu=__webpack_require__("./src/components/ChatInput/EmojiMenu.js");function normalizeDate(input){if(!input)return null;if("object"==typeof input&&"function"==typeof input.toDate)try{return input.toDate()}catch(_unused){return null}if(input instanceof Date)return input;const d=new Date(input);return isNaN(d.getTime())?null:d}function formatTimestamp(timestamp){const date=normalizeDate(timestamp);if(!date)return"";const mm=String(date.getMonth()+1).padStart(2,"0"),dd=String(date.getDate()).padStart(2,"0"),yyyy=date.getFullYear();let hrs=date.getHours();const ampm=hrs>=12?"PM":"AM";hrs%=12,0===hrs&&(hrs=12);const mins=String(date.getMinutes()).padStart(2,"0");return"".concat(mm,"/").concat(dd,"/").concat(yyyy," ").concat(hrs,":").concat(mins," ").concat(ampm)}function formatTimeOnly(timestamp){const date=normalizeDate(timestamp);if(!date)return"";let hrs=date.getHours();const ampm=hrs>=12?"PM":"AM";hrs%=12,0===hrs&&(hrs=12);const mins=String(date.getMinutes()).padStart(2,"0");return"".concat(hrs,":").concat(mins," ").concat(ampm)}function formatFullTimestamp(timestamp){const date=normalizeDate(timestamp);return date?date.toLocaleString():""}function buildMessageId(message){if(!message)return"";const{id,documentId,_id,uid,createdAt}=message;if(id)return id;if(documentId)return documentId;if(_id)return _id;const seconds=(null==createdAt?void 0:createdAt.seconds)||Math.floor(Date.now()/1e3);return"temp_".concat(uid||"unknown","_").concat(seconds)}function relativeLastActive(ts){let{now=Date.now()}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!ts)return"";const diff=now-ts;if(diff<0)return"just now";const mins=Math.floor(diff/6e4);if(mins<1)return"just now";if(mins<60)return"".concat(mins,"m ago");const h=Math.floor(mins/60);if(h<24)return"".concat(h,"h ago");const d=Math.floor(h/24);return"".concat(d,"d ago")}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function highlightText(raw,term){if(!raw||!term)return raw;const escaped=function escapeRegex(term){return term.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(term),regex=new RegExp("(".concat(escaped,")"),"gi");return raw.split(regex).map((part,i)=>regex.test(part)?(0,jsx_runtime.jsx)("mark",{className:"search-highlight",children:part},i):part)}function AvatarWithPresence(_ref){let{uid,photoURL,displayName,presenceState="offline",presenceTitle="",size=36,onClick}=_ref;const fallback=react.useMemo(()=>getFallbackAvatar({uid,displayName,size:size+4}),[uid,displayName,size]),initialSrc=photoURL||fallback,[src,setSrc]=react.useState(initialSrc),handleError=react.useCallback(e=>{"true"!==e.target.dataset.fallbackApplied&&(setSrc(fallback),e.target.dataset.fallbackApplied="true")},[fallback]);return(0,jsx_runtime.jsxs)("div",{className:"avatar-container",role:"button",tabIndex:0,title:"View ".concat(displayName||"user","'s profile"),"aria-label":"View ".concat(displayName||"user","'s profile"),onClick,onKeyDown:e=>{"Enter"===e.key&&onClick&&onClick(e)},"data-testid":"avatar-with-presence",children:[(0,jsx_runtime.jsx)("img",{src,alt:displayName?"".concat(displayName,"'s avatar"):"User avatar",className:"message-avatar",style:{width:size,height:size},loading:"lazy",decoding:"async",onError:handleError,"data-testid":"avatar-image","data-current-src":src}),(0,jsx_runtime.jsx)("div",{className:"status-indicator ".concat(presenceState),title:presenceTitle,"aria-label":presenceTitle,"data-testid":"status-indicator"})]})}function InlineReplyContext(_ref){let{replyTo,onViewProfile,onNavigate}=_ref;const{id,uid,displayName,text,type,photoURL}=replyTo||{},fallbackAvatar=react.useMemo(()=>getFallbackAvatar({uid:uid||"x",displayName,size:24}),[uid,displayName]);if(!replyTo)return null;const snippet=text||("image"===type?"Image":"")||"",handleNavigate=()=>{id&&onNavigate&&onNavigate(id)},handleProfile=()=>{onViewProfile&&onViewProfile({uid,displayName,photoURL:photoURL||fallbackAvatar})};return(0,jsx_runtime.jsxs)("div",{className:"inline-reply-context","data-testid":"inline-reply-context",children:[(0,jsx_runtime.jsx)("span",{className:"irc-glyph","aria-hidden":"true",children:"❝"}),(0,jsx_runtime.jsx)("div",{className:"irc-avatar",role:"button",tabIndex:0,onClick:handleProfile,onKeyDown:e=>{"Enter"===e.key&&handleProfile()},title:"View ".concat(displayName||"user"," profile"),"data-testid":"irc-avatar",children:(0,jsx_runtime.jsx)("img",{src:photoURL||fallbackAvatar,alt:displayName?"".concat(displayName," avatar"):"User avatar",loading:"lazy",decoding:"async"})}),(0,jsx_runtime.jsx)("button",{className:"irc-name",onClick:handleProfile,title:"View ".concat(displayName||"user"," profile"),type:"button","data-testid":"irc-name-btn",children:displayName||"Unknown"}),(0,jsx_runtime.jsx)("span",{className:"irc-text",role:id?"link":void 0,tabIndex:id?0:-1,onClick:handleNavigate,onKeyDown:e=>{"Enter"===e.key&&handleNavigate()},title:snippet,"data-testid":"irc-snippet",children:snippet}),(0,jsx_runtime.jsx)("span",{className:"irc-glyph rotate-180","aria-hidden":"true",children:"❝"})]})}AvatarWithPresence.__docgenInfo={description:"AvatarWithPresence\r\nRenders a user avatar with a presence status indicator.\r\nHandles fallback avatar generation and error substitution.",methods:[],displayName:"AvatarWithPresence",props:{presenceState:{defaultValue:{value:"'offline'",computed:!1},required:!1},presenceTitle:{defaultValue:{value:"''",computed:!1},required:!1},size:{defaultValue:{value:"36",computed:!1},required:!1}}},InlineReplyContext.__docgenInfo={description:"InlineReplyContext\r\nDisplays a compact reference to the replied-to message (avatar, name, snippet).\r\nProps:\r\n - replyTo: { id, uid, displayName, text, type, photoURL }\r\n - onViewProfile(userLike)\r\n - onNavigate(id) -> called when snippet clicked/Enter (for scrolling + highlight)",methods:[],displayName:"InlineReplyContext"};const ReactionList=_ref=>{let{reactions,currentUserId,onToggle}=_ref;return reactions&&0!==Object.keys(reactions).length?(0,jsx_runtime.jsx)("div",{className:"message-reactions","data-testid":"reaction-list",children:Object.entries(reactions).map(_ref2=>{let[emoji,userIds]=_ref2;const isArray=Array.isArray(userIds),count=isArray?userIds.length:"number"==typeof userIds?userIds:0,hasUserReacted=!!isArray&&userIds.includes(currentUserId);return(0,jsx_runtime.jsxs)("span",{className:"reaction ".concat(hasUserReacted?"reacted":""),onClick:()=>onToggle&&onToggle(emoji),onKeyDown:e=>{"Enter"===e.key&&onToggle&&onToggle(emoji)},role:"button",tabIndex:0,"aria-pressed":hasUserReacted,"aria-label":"".concat(emoji," reaction, ").concat(count," user").concat(1!==count?"s":"",". ").concat(hasUserReacted?"You reacted.":"Activate to toggle your reaction."),title:"".concat(count," reaction").concat(1!==count?"s":""),"data-testid":"reaction-item",children:[emoji," ",count]},emoji)})}):null},parts_ReactionList=react.memo(ReactionList);function ReactionBar(_ref){let{emojis,onReact,onReply,message,menuOpen,children}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"reaction-buttons ".concat(menuOpen?"force-visible":""),"data-testid":"reaction-bar",children:[emojis.map(emoji=>(0,jsx_runtime.jsx)("button",{className:"reaction-btn","data-tip":"React ".concat(emoji),onClick:()=>onReact&&onReact(emoji),"aria-label":"React to message with ".concat(emoji),"data-testid":"reaction-btn",children:emoji},emoji)),onReply&&(0,jsx_runtime.jsx)("button",{className:"reply-btn quote-reply-btn","data-tip":"Reply",onClick:()=>onReply(message),"aria-label":"Reply to this message","data-testid":"reply-btn",children:"❝"}),children]})}ReactionList.__docgenInfo={description:"",methods:[],displayName:"ReactionList"},ReactionBar.__docgenInfo={description:"",methods:[],displayName:"ReactionBar"};var react_dom=__webpack_require__("./node_modules/react-dom/index.js");function MessageOptionsMenu(_ref){let{open,menuPanelRef,menuMode,menuReady,menuStyle,quickMenuEmojis,addReaction,handleAddReactionFull,onReply,message,handleCopyText,canEdit,startEditing,canDelete,onDelete,text}=_ref;return open?(0,react_dom.createPortal)((0,jsx_runtime.jsxs)("div",{ref:menuPanelRef,className:"message-menu open mode-".concat(menuMode," ").concat(menuReady?"ready":"measuring"),role:"menu","aria-label":"Message options",onMouseDown:e=>e.stopPropagation(),style:menuStyle,"data-testid":"message-options-menu",children:[(0,jsx_runtime.jsx)("div",{className:"menu-reactions-row",role:"group","aria-label":"Quick reactions",children:quickMenuEmojis.map(r=>(0,jsx_runtime.jsx)("button",{className:"menu-reaction-btn","data-tip":"React ".concat(r),onClick:()=>{addReaction(r)},"aria-label":"React with ".concat(r),children:r},r))}),(0,jsx_runtime.jsx)("div",{className:"menu-divider"}),(0,jsx_runtime.jsxs)("button",{role:"menuitem",className:"menu-item",onClick:handleAddReactionFull,children:["Add Reaction",(0,jsx_runtime.jsx)("span",{className:"menu-item-icon","aria-hidden":!0,children:"+"})]}),onReply&&(0,jsx_runtime.jsxs)("button",{role:"menuitem",className:"menu-item",onClick:()=>{onReply(message)},children:["Reply",(0,jsx_runtime.jsx)("span",{className:"menu-item-icon","aria-hidden":!0,children:"↩"})]}),(0,jsx_runtime.jsxs)("button",{role:"menuitem",className:"menu-item",onClick:handleCopyText,disabled:!text,children:["Copy Text",(0,jsx_runtime.jsx)("span",{className:"menu-item-icon","aria-hidden":!0,children:"⧉"})]}),canEdit&&(0,jsx_runtime.jsxs)("button",{role:"menuitem",onClick:startEditing,className:"menu-item",children:["Edit",(0,jsx_runtime.jsx)("span",{className:"menu-item-icon","aria-hidden":!0,children:"✎"})]}),canDelete&&(0,jsx_runtime.jsxs)("button",{role:"menuitem",onClick:onDelete,className:"menu-item delete-item",children:["Delete",(0,jsx_runtime.jsx)("span",{className:"menu-item-icon","aria-hidden":!0,children:"⌫"})]})]}),document.body):null}function EditMessageForm(_ref){let{value,onChange,onSave,onCancel,onKeyDown}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"edit-container","data-testid":"edit-message-form",children:[(0,jsx_runtime.jsx)("textarea",{value,onChange:e=>onChange(e.target.value),onKeyDown,"aria-label":"Edit message text",autoFocus:!0}),(0,jsx_runtime.jsxs)("div",{className:"edit-actions",children:[(0,jsx_runtime.jsx)("button",{onClick:onSave,"aria-label":"Save edit",className:"save-edit-btn",children:"Save"}),(0,jsx_runtime.jsx)("button",{onClick:onCancel,"aria-label":"Cancel edit",className:"cancel-edit-btn",children:"Cancel"})]})]})}function DeleteConfirmModal(_ref){let{open,onConfirm,onCancel}=_ref;return open?(0,jsx_runtime.jsxs)("div",{className:"delete-modal-overlay",role:"dialog","aria-modal":"true","aria-label":"Confirm delete",onMouseDown:e=>{e.stopPropagation()},onClick:e=>{e.stopPropagation()},"data-testid":"delete-confirm-modal",children:[(0,jsx_runtime.jsxs)("div",{className:"delete-modal",onMouseDown:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),children:[(0,jsx_runtime.jsx)("h4",{children:"Delete message?"}),(0,jsx_runtime.jsx)("p",{className:"no-bg",children:"This action cannot be undone."}),(0,jsx_runtime.jsxs)("div",{className:"delete-modal-actions",children:[(0,jsx_runtime.jsx)("button",{className:"danger",onClick:onConfirm,autoFocus:!0,children:"Delete"}),(0,jsx_runtime.jsx)("button",{onClick:onCancel,children:"Cancel"})]})]}),(0,jsx_runtime.jsx)("div",{className:"delete-modal-backdrop-click-capture",onMouseDown:e=>{e.stopPropagation(),onCancel()}})]}):null}function ImagePreviewModal(_ref){let{open,src,onClose}=_ref;return open?(0,jsx_runtime.jsx)("div",{className:"image-modal",onClick:onClose,role:"dialog","aria-modal":"true","aria-label":"Image preview","data-testid":"image-preview-modal",children:(0,jsx_runtime.jsxs)("div",{className:"image-modal-content",onClick:e=>e.stopPropagation(),children:[(0,jsx_runtime.jsx)("img",{src,alt:"Full size view"}),(0,jsx_runtime.jsx)("button",{className:"image-modal-close",onClick:onClose,"aria-label":"Close image preview",children:"✕"})]})}):null}function MessageHeader(_ref){let{userName,createdAt,formatTimestamp,onViewProfile}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"message-header","data-testid":"message-header",children:[(0,jsx_runtime.jsx)("div",{className:"message-username",onClick:onViewProfile,onKeyDown:e=>{"Enter"===e.key&&onViewProfile()},style:{cursor:"pointer"},title:"View ".concat(userName,"'s profile"),role:"button",tabIndex:0,"aria-label":"View profile for ".concat(userName),children:userName}),(0,jsx_runtime.jsx)("div",{className:"message-timestamp",children:formatTimestamp(createdAt)})]})}function HoverTimestamp(_ref){let{createdAt,formatTimestamp}=_ref;const label=formatTimestamp(createdAt);return(0,jsx_runtime.jsx)("div",{className:"hover-time",title:label,"aria-hidden":"true","data-testid":"hover-timestamp",children:label.split(", ")[1]})}function useReactions(_ref){let{firestore,auth,messageId,initialReactions={}}=_ref;const[reactions,setReactions]=(0,react.useState)(initialReactions);return{reactions,toggleReaction:(0,react.useCallback)(async emoji=>{if(!messageId||null==auth||!auth.currentUser)return;let nextState;setReactions(prev=>{const next=(0,objectSpread2.A)({},prev),uid=auth.currentUser.uid;next[emoji]||(next[emoji]=[]),"number"==typeof next[emoji]&&(next[emoji]=[]);const arr=next[emoji],idx=arr.indexOf(uid);return idx>-1?(arr.splice(idx,1),0===arr.length&&delete next[emoji]):arr.push(uid),nextState=next,next});try{const ref=(0,index_esm.H9)(firestore,"messages",messageId);await(0,index_esm.mZ)(ref,{reactions:nextState&&Object.keys(nextState).length?nextState:{}})}catch(e){console.error("❌ Reaction update failed",e)}},[messageId,auth,firestore])}}EditMessageForm.__docgenInfo={description:"",methods:[],displayName:"EditMessageForm"},DeleteConfirmModal.__docgenInfo={description:"",methods:[],displayName:"DeleteConfirmModal"},ImagePreviewModal.__docgenInfo={description:"",methods:[],displayName:"ImagePreviewModal"},MessageHeader.__docgenInfo={description:"",methods:[],displayName:"MessageHeader"},HoverTimestamp.__docgenInfo={description:"",methods:[],displayName:"HoverTimestamp"};function useMessageMenuPosition(_ref){let{menuOpen,onClose,showDeleteConfirm}=_ref;const menuRef=react.useRef(null),menuPanelRef=react.useRef(null),[menuMode,setMenuMode]=react.useState("down"),[menuStyle,setMenuStyle]=react.useState({}),[menuReady,setMenuReady]=react.useState(!1),computeMenuPosition=react.useCallback(()=>{if(!menuOpen)return;const wrapper=menuRef.current,panel=menuPanelRef.current;if(!wrapper||!panel)return;const triggerBtn=wrapper.querySelector(".message-menu-trigger"),triggerRect=triggerBtn?triggerBtn.getBoundingClientRect():wrapper.getBoundingClientRect(),messageEl=wrapper.closest(".message"),messageRect=messageEl?messageEl.getBoundingClientRect():triggerRect,panelHeight=panel.offsetHeight||panel.scrollHeight||200,panelWidth=panel.offsetWidth||240,viewportW=window.innerWidth,viewportH=window.innerHeight;let sideLeft=messageRect.right+8;let top;if(sideLeft+panelWidth+8<=viewportW){let t=Math.min(Math.max(messageRect.top,8),Math.max(8,viewportH-panelHeight-8));return setMenuMode("side"),setMenuStyle({top:Math.round(t),left:Math.round(sideLeft)}),void setMenuReady(!0)}const spaceAbove=triggerRect.top,needed=panelHeight+16;let mode="down";mode=viewportH-triggerRect.bottom>=needed?"down":spaceAbove>=needed?"up":"middle",top="down"===mode?triggerRect.bottom+4:"up"===mode?Math.max(8,triggerRect.top-panelHeight-4):Math.max(8,(viewportH-panelHeight)/2);let left=triggerRect.right-panelWidth;left=Math.min(left,viewportW-panelWidth-8),left=Math.max(8,left),setMenuMode(mode),setMenuStyle(prev=>{const next={top:Math.round(top),left:Math.round(left)};return prev.top===next.top&&prev.left===next.left?prev:next}),setMenuReady(!0)},[menuOpen]);return react.useEffect(()=>{if(menuOpen)document.body.classList.add("chat-menu-open");else{document.querySelector(".message-menu.open")||document.body.classList.remove("chat-menu-open")}return()=>{document.querySelector(".message-menu.open")||document.body.classList.remove("chat-menu-open")}},[menuOpen]),react.useEffect(()=>{if(!menuOpen)return;const onPointerDown=e=>{if(showDeleteConfirm)return;const wrap=menuRef.current,panel=menuPanelRef.current;if(!wrap)return;const insideTrigger=wrap.contains(e.target),insidePanel=panel&&panel.contains(e.target);insideTrigger||insidePanel||null==onClose||onClose()},onKey=e=>{"Escape"===e.key&&(null==onClose||onClose())};return document.addEventListener("pointerdown",onPointerDown,!0),document.addEventListener("keydown",onKey,!0),()=>{document.removeEventListener("pointerdown",onPointerDown,!0),document.removeEventListener("keydown",onKey,!0)}},[menuOpen,onClose,showDeleteConfirm]),react.useLayoutEffect(()=>{if(!menuOpen)return;setMenuReady(!1);const raf=requestAnimationFrame(computeMenuPosition);return()=>cancelAnimationFrame(raf)},[menuOpen,computeMenuPosition]),react.useEffect(()=>{if(!menuOpen)return;const raf=requestAnimationFrame(computeMenuPosition);return window.addEventListener("resize",computeMenuPosition),window.addEventListener("scroll",computeMenuPosition,!0),()=>{cancelAnimationFrame(raf),window.removeEventListener("resize",computeMenuPosition),window.removeEventListener("scroll",computeMenuPosition,!0)}},[menuOpen,computeMenuPosition]),react.useEffect(()=>{if(!menuOpen)return;const t=setTimeout(()=>{setMenuReady(r=>r||(setMenuMode("down"),setMenuStyle(s=>{var _s$top,_s$left;return{top:null!==(_s$top=s.top)&&void 0!==_s$top?_s$top:100,left:null!==(_s$left=s.left)&&void 0!==_s$left?_s$left:100}}),!0))},120);return()=>clearTimeout(t)},[menuOpen]),{menuRef,menuPanelRef,menuMode,menuStyle,menuReady}}function ChatMessage_ChatMessage(props){var _auth$currentUser5,_auth$currentUser6,_auth$currentUser7;const{firestore,auth}=(0,FirebaseContext.D3)(),{text,uid,photoURL,reactions={},id,createdAt,imageURL,type,displayName,replyTo,editedAt,deleted}=props.message,{searchTerm,getDisplayName,onReply,isReplyTarget,onViewProfile,showMeta=!0}=props,presence=(0,PresenceContext.xQ)(uid),isTyping=!!presence.typing,presenceState=isTyping?"online":presence.state,presenceTitle=(()=>{const label={online:"Online",away:"Away",offline:"Offline"}[presenceState]||"Offline",rel=relativeLastActive(presence.lastSeen);return rel?isTyping?"Typing… (was ".concat(label,", last active ").concat(rel,")"):"".concat(label," (last active ").concat(rel,")"):label})(),[showFullImage,setShowFullImage]=react.useState(!1),[menuOpen,setMenuOpen]=react.useState(!1),[isEditing,setIsEditing]=react.useState(!1),[editText,setEditText]=react.useState(text||""),[showDeleteConfirm,setShowDeleteConfirm]=react.useState(!1),{menuRef,menuPanelRef,menuMode,menuStyle,menuReady}=useMessageMenuPosition({menuOpen,onClose:()=>setMenuOpen(!1),showDeleteConfirm}),messageId=buildMessageId(props.message);id||props.message.documentId||props.message._id||(console.log("📨 ChatMessage missing ID - Message:",props.message),console.log("📨 Available props:",Object.keys(props.message)));const messageClass=uid===auth.currentUser.uid?"sent":"received",userName=getDisplayName?getDisplayName(uid,displayName):displayName||"Anonymous",fallbackAvatar=react.useMemo(()=>getFallbackAvatar({uid,displayName:userName,size:40}),[uid,userName]),handleViewProfileClick=async()=>{if(onViewProfile){var _auth$currentUser;let profileUser={uid,displayName:userName,photoURL:photoURL||fallbackAvatar};uid===(null===(_auth$currentUser=auth.currentUser)||void 0===_auth$currentUser?void 0:_auth$currentUser.uid)&&(profileUser.email=auth.currentUser.email),onViewProfile(profileUser)}},{reactions:reactionsState,toggleReaction}=useReactions({firestore,auth,messageId,initialReactions:reactions}),addReaction=emoji=>toggleReaction(emoji),reactionEmojis=react.useMemo(()=>["👍","❤️","😂"],[]),quickMenuEmojis=react.useMemo(()=>["👍","❤️","😂"],[]),startEditing=()=>{setEditText(text||""),setIsEditing(!0),setMenuOpen(!1)},cancelEditing=()=>{setIsEditing(!1),setEditText(text||"")},saveEdit=async()=>{if(messageId&&auth.currentUser&&""!==editText.trim()&&editText!==text)try{const messageRef=(0,index_esm.H9)(firestore,"messages",messageId);await(0,index_esm.mZ)(messageRef,{text:editText.trim(),editedAt:(0,index_esm.O5)()})}catch(e){console.error("❌ Error editing message:",e)}finally{setIsEditing(!1)}else setIsEditing(!1)},handleDelete=async()=>{if(messageId&&auth.currentUser)try{const messageRef=(0,index_esm.H9)(firestore,"messages",messageId);await(0,index_esm.mZ)(messageRef,{text:"-deleted-",deleted:!0,imageURL:null,editedAt:(0,index_esm.O5)()})}catch(e){console.error("❌ Error soft-deleting message:",e)}finally{setShowDeleteConfirm(!1),setMenuOpen(!1)}},handleCopyText=async()=>{if(text){try{await navigator.clipboard.writeText(text)}catch(e){console.error("❌ Clipboard copy failed:",e)}document.dispatchEvent(new CustomEvent("chat:prefill",{detail:{text}}))}setMenuOpen(!1)},handleAddReactionFull=e=>{const target=null==e?void 0:e.currentTarget;let anchorRect=null;target&&(anchorRect=target.getBoundingClientRect()),EmojiMenu.Ay.open({anchorRect,onSelect:emojiData=>{null!=emojiData&&emojiData.emoji&&addReaction(emojiData.emoji)}}),setMenuOpen(!1)},onEditKeyDown=e=>{"Enter"!==e.key||e.shiftKey?"Escape"===e.key&&(e.preventDefault(),cancelEditing()):(e.preventDefault(),saveEdit())},rootClasses=["message",messageClass,isReplyTarget?"reply-target":"",replyTo?"has-inline-reply":"",showMeta?"with-meta":"no-meta"].filter(Boolean).join(" ");if(!showMeta){var _auth$currentUser2,_auth$currentUser3,_auth$currentUser4;const timeOnly=formatTimeOnly(createdAt);return(0,jsx_runtime.jsxs)("div",{className:rootClasses,"data-message-id":messageId,role:"article","aria-label":"Message from ".concat(userName),children:[(0,jsx_runtime.jsx)("div",{className:"time-col","aria-hidden":"true",children:timeOnly}),(0,jsx_runtime.jsxs)("div",{className:"message-content",children:[deleted?(0,jsx_runtime.jsx)("p",{className:"deleted-message","aria-label":"Message deleted",children:"This message was deleted."}):isEditing?(0,jsx_runtime.jsx)(EditMessageForm,{value:editText,onChange:setEditText,onSave:saveEdit,onCancel:cancelEditing,onKeyDown:onEditKeyDown}):"image"===type&&imageURL?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"message-image",children:(0,jsx_runtime.jsx)("img",{src:imageURL,alt:"Shared content",onClick:()=>setShowFullImage(!0),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"===e.key&&setShowFullImage(!0)},"aria-label":"Open image in modal",loading:"lazy",decoding:"async"})}),(0,jsx_runtime.jsx)(ImagePreviewModal,{open:showFullImage,src:imageURL,onClose:()=>setShowFullImage(!1)})]}):text&&(0,jsx_runtime.jsxs)("p",{children:[highlightText(text,searchTerm)," ",editedAt&&(0,jsx_runtime.jsx)("sub",{className:"edited-label",title:"Edited ".concat(formatFullTimestamp(editedAt)),children:" (edited)"})]}),(0,jsx_runtime.jsx)(parts_ReactionList,{reactions:reactionsState,currentUserId:null===(_auth$currentUser2=auth.currentUser)||void 0===_auth$currentUser2?void 0:_auth$currentUser2.uid,onToggle:addReaction}),(0,jsx_runtime.jsx)(ReactionBar,{emojis:reactionEmojis,onReact:addReaction,onReply,message:props.message,menuOpen,children:!deleted&&(0,jsx_runtime.jsxs)("div",{className:"message-menu-wrapper",ref:menuRef,children:[(0,jsx_runtime.jsx)("button",{className:"reply-btn message-menu-trigger","data-tip":"Options","aria-label":"Options","aria-haspopup":"true","aria-expanded":menuOpen,onClick:()=>setMenuOpen(o=>!o),children:"…"}),(0,jsx_runtime.jsx)(MessageOptionsMenu,{open:menuOpen,menuPanelRef,menuMode,menuReady,menuStyle,quickMenuEmojis,addReaction:e=>{addReaction(e),setMenuOpen(!1)},handleAddReactionFull,onReply:onReply?m=>{onReply(m),setMenuOpen(!1)}:void 0,message:props.message,handleCopyText,canEdit:uid===(null===(_auth$currentUser3=auth.currentUser)||void 0===_auth$currentUser3?void 0:_auth$currentUser3.uid)&&"image"!==type,startEditing:()=>{startEditing(),setMenuOpen(!1)},canDelete:uid===(null===(_auth$currentUser4=auth.currentUser)||void 0===_auth$currentUser4?void 0:_auth$currentUser4.uid),onDelete:()=>{setShowDeleteConfirm(!0),setMenuOpen(!1)},text})]})})]}),(0,jsx_runtime.jsx)(DeleteConfirmModal,{open:showDeleteConfirm,onConfirm:handleDelete,onCancel:()=>setShowDeleteConfirm(!1)})]})}return(0,jsx_runtime.jsx)("div",{className:rootClasses,"data-message-id":messageId,role:"article","aria-label":"Message from ".concat(userName).concat(isReplyTarget?" (reply target)":""),children:(0,jsx_runtime.jsxs)("div",{className:"message-inner",children:[replyTo&&showMeta&&(0,jsx_runtime.jsxs)("div",{className:"message-top-row","aria-label":"Replying to ".concat(replyTo.displayName||"user"),children:[(0,jsx_runtime.jsx)("div",{className:"avatar-spacer","aria-hidden":"true"}),(0,jsx_runtime.jsx)("div",{className:"reply-contexts",children:(0,jsx_runtime.jsx)(InlineReplyContext,{replyTo,onViewProfile:handleViewProfileClick,onNavigate:id=>{const selector='[data-message-id="'.concat(id,'"]'),targetEl=document.querySelector(selector);if(targetEl){targetEl.scrollIntoView({behavior:"smooth",block:"center"}),targetEl.classList.add("reply-flash");let addedTemp=!1;targetEl.classList.contains("reply-target")||(targetEl.classList.add("reply-target"),addedTemp=!0),setTimeout(()=>{targetEl.classList.remove("reply-flash")},600),addedTemp&&setTimeout(()=>{targetEl.classList.remove("reply-target")},3e3)}}})})]}),(0,jsx_runtime.jsxs)("div",{className:"message-main-row",children:[showMeta&&(0,jsx_runtime.jsx)(AvatarWithPresence,{uid,photoURL,displayName:userName,presenceState,presenceTitle,onClick:handleViewProfileClick}),(0,jsx_runtime.jsxs)("div",{className:"message-content",children:[showMeta&&(0,jsx_runtime.jsx)(MessageHeader,{userName,createdAt,formatTimestamp,onViewProfile:handleViewProfileClick}),!showMeta&&(0,jsx_runtime.jsx)(HoverTimestamp,{createdAt,formatTimestamp}),"image"===type&&imageURL&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{className:"message-image",children:(0,jsx_runtime.jsx)("img",{src:imageURL,alt:"Shared content",onClick:()=>setShowFullImage(!0),role:"button",tabIndex:0,onKeyDown:e=>{"Enter"===e.key&&setShowFullImage(!0)},"aria-label":"Open image in modal",loading:"lazy",decoding:"async"})}),(0,jsx_runtime.jsx)(ImagePreviewModal,{open:showFullImage,src:imageURL,onClose:()=>setShowFullImage(!1)})]}),deleted&&(0,jsx_runtime.jsx)("p",{className:"deleted-message","aria-label":"Message deleted",children:"This message was deleted."}),!deleted&&(isEditing?(0,jsx_runtime.jsx)(EditMessageForm,{value:editText,onChange:setEditText,onSave:saveEdit,onCancel:cancelEditing,onKeyDown:onEditKeyDown}):text&&(0,jsx_runtime.jsxs)("p",{children:[highlightText(text,searchTerm)," ",editedAt&&(0,jsx_runtime.jsx)("sub",{className:"edited-label",title:"Edited ".concat(formatFullTimestamp(editedAt)),children:" (edited)"})]})),(0,jsx_runtime.jsx)(parts_ReactionList,{reactions:reactionsState,currentUserId:null===(_auth$currentUser5=auth.currentUser)||void 0===_auth$currentUser5?void 0:_auth$currentUser5.uid,onToggle:addReaction}),(0,jsx_runtime.jsx)(ReactionBar,{emojis:reactionEmojis,onReact:addReaction,onReply,message:props.message,menuOpen,children:!deleted&&(0,jsx_runtime.jsxs)("div",{className:"message-menu-wrapper",ref:menuRef,children:[(0,jsx_runtime.jsx)("button",{className:"reply-btn message-menu-trigger","data-tip":"Options","aria-label":"Options","aria-haspopup":"true","aria-expanded":menuOpen,onClick:()=>setMenuOpen(o=>!o),children:"…"}),(0,jsx_runtime.jsx)(MessageOptionsMenu,{open:menuOpen,menuPanelRef,menuMode,menuReady,menuStyle,quickMenuEmojis,addReaction:e=>{addReaction(e),setMenuOpen(!1)},handleAddReactionFull,onReply:onReply?m=>{onReply(m),setMenuOpen(!1)}:void 0,message:props.message,handleCopyText,canEdit:uid===(null===(_auth$currentUser6=auth.currentUser)||void 0===_auth$currentUser6?void 0:_auth$currentUser6.uid)&&"image"!==type,startEditing:()=>{startEditing(),setMenuOpen(!1)},canDelete:uid===(null===(_auth$currentUser7=auth.currentUser)||void 0===_auth$currentUser7?void 0:_auth$currentUser7.uid),onDelete:()=>{setShowDeleteConfirm(!0),setMenuOpen(!1)},text})]})})]}),(0,jsx_runtime.jsx)(DeleteConfirmModal,{open:showDeleteConfirm,onConfirm:handleDelete,onCancel:()=>setShowDeleteConfirm(!1)})]})]})})}const ChatRoom_ChatMessage=ChatMessage_ChatMessage;ChatMessage_ChatMessage.__docgenInfo={description:"",methods:[],displayName:"ChatMessage"};const baseTimestamp=new Date,makeMsg=overrides=>(0,objectSpread2.A)({id:overrides.id||Math.random().toString(36).slice(2),text:"Hello world from Storybook!",uid:"user_other",photoURL:"",createdAt:baseTimestamp,displayName:"Alice",reactions:{},type:"text"},overrides),ChatMessage_stories={title:"Chat/ChatMessage",component:ChatRoom_ChatMessage,args:{searchTerm:"",getDisplayName:(uid,fallback)=>({user_other:"Alice",user_current:"You",user_offline:"Ghost"}[uid]||fallback||"User"),onReply:()=>{},onViewProfile:()=>{},showMeta:!0},parameters:{chromatic:{disableSnapshot:!1}}},TextReceived=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({text:"A plain received message."})})),TextSent=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({uid:"user_current",displayName:"You",text:"A message I sent."})})),WithReactions=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({text:"Message with reactions",reactions:{"👍":["user_current","user_other"],"❤️":["user_other"]}})})),ImageMessage=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({type:"image",imageURL:"https://placehold.co/300x160/png",text:""})})),DeletedMessage=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({text:"-deleted-",deleted:!0})})),EditedMessage=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({text:"Edited content here",editedAt:new Date(Date.now()-6e4)})})),ReplyMessage=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:makeMsg({text:"Replying here",replyTo:{id:"prior1",displayName:"Alice",text:"Original message excerpt",uid:"user_other"}})})),NoMetaGrouped=args=>(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{showMeta:!1,message:makeMsg({text:"Grouped message no meta",uid:"user_current"})})),MenuOpenState=args=>{const msg=makeMsg({text:"Message with options menu open"});return(0,jsx_runtime.jsx)(ChatRoom_ChatMessage,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{message:msg}))},__namedExportsOrder=["TextReceived","TextSent","WithReactions","ImageMessage","DeletedMessage","EditedMessage","ReplyMessage","NoMetaGrouped","MenuOpenState"];TextReceived.parameters={...TextReceived.parameters,docs:{...TextReceived.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  text: 'A plain received message.'\n})} />",...TextReceived.parameters?.docs?.source}}},TextSent.parameters={...TextSent.parameters,docs:{...TextSent.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  uid: 'user_current',\n  displayName: 'You',\n  text: 'A message I sent.'\n})} />",...TextSent.parameters?.docs?.source}}},WithReactions.parameters={...WithReactions.parameters,docs:{...WithReactions.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  text: 'Message with reactions',\n  reactions: {\n    '👍': ['user_current', 'user_other'],\n    '❤️': ['user_other']\n  }\n})} />",...WithReactions.parameters?.docs?.source}}},ImageMessage.parameters={...ImageMessage.parameters,docs:{...ImageMessage.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  type: 'image',\n  imageURL: 'https://placehold.co/300x160/png',\n  text: ''\n})} />",...ImageMessage.parameters?.docs?.source}}},DeletedMessage.parameters={...DeletedMessage.parameters,docs:{...DeletedMessage.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  text: '-deleted-',\n  deleted: true\n})} />",...DeletedMessage.parameters?.docs?.source}}},EditedMessage.parameters={...EditedMessage.parameters,docs:{...EditedMessage.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  text: 'Edited content here',\n  editedAt: new Date(Date.now() - 60000)\n})} />",...EditedMessage.parameters?.docs?.source}}},ReplyMessage.parameters={...ReplyMessage.parameters,docs:{...ReplyMessage.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} message={makeMsg({\n  text: 'Replying here',\n  replyTo: {\n    id: 'prior1',\n    displayName: 'Alice',\n    text: 'Original message excerpt',\n    uid: 'user_other'\n  }\n})} />",...ReplyMessage.parameters?.docs?.source}}},NoMetaGrouped.parameters={...NoMetaGrouped.parameters,docs:{...NoMetaGrouped.parameters?.docs,source:{originalSource:"args => <ChatMessage {...args} showMeta={false} message={makeMsg({\n  text: 'Grouped message no meta',\n  uid: 'user_current'\n})} />",...NoMetaGrouped.parameters?.docs?.source}}},MenuOpenState.parameters={...MenuOpenState.parameters,docs:{...MenuOpenState.parameters?.docs,source:{originalSource:"args => {\n  // Show menu by simulating internal state via wrapper that toggles after mount\n  const msg = makeMsg({\n    text: 'Message with options menu open'\n  });\n  // We cannot directly force menu open via prop; rely on user click in Chromatic (not ideal). Instead leave as standard.\n  return <ChatMessage {...args} message={msg} />;\n}",...MenuOpenState.parameters?.docs?.source}}}}}]);