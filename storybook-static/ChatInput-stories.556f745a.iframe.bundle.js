"use strict";(self.webpackChunkdungeonchat=self.webpackChunkdungeonchat||[]).push([[191],{"./src/components/ChatInput/EmojiMenu.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Ay:()=>__WEBPACK_DEFAULT_EXPORT__});var C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/objectSpread2.js"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/index.js"),react_dom__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/react-dom/index.js"),emoji_picker_react__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/emoji-picker-react/dist/emoji-picker-react.esm.js"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/react/jsx-runtime.js");let externalOpen,mountNode;function EmojiMenuSingleton(){const[state,setState]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)({visible:!1,anchorRect:null,onSelect:null,onClose:null}),stateRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(state);(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{stateRef.current=state},[state]);const panelRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(null),[panelStyle,setPanelStyle]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(null),close=(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)(()=>{setState(s=>(0,C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__.A)((0,C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__.A)({},s),{},{visible:!1}));const latest=stateRef.current;latest.onClose&&latest.onClose()},[]),open=(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)(opts=>{setState({visible:!0,anchorRect:opts.anchorRect||null,onSelect:opts.onSelect||null,onClose:opts.onClose||null})},[]);(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{externalOpen=open},[open]),(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{if(!state.visible)return;const onKey=e=>{"Escape"===e.key&&close()},onPointer=e=>{const panel=panelRef.current;panel&&!panel.contains(e.target)&&close()};return document.addEventListener("keydown",onKey,!0),document.addEventListener("pointerdown",onPointer,!0),()=>{document.removeEventListener("keydown",onKey,!0),document.removeEventListener("pointerdown",onPointer,!0)}},[state.visible,close]),(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{if(!state.visible)return void setPanelStyle(null);if(!panelRef.current||!state.anchorRect)return;const anchor=state.anchorRect,panelRect=panelRef.current.getBoundingClientRect(),bounds=(document.querySelector(".App section")||document.querySelector(".App")||document.body).getBoundingClientRect();let top=anchor.top-panelRect.height-6,placeAbove=!0;top<bounds.top+4&&(top=anchor.bottom+6,placeAbove=!1);let left=anchor.left;if(left+panelRect.width>bounds.right-4&&(left=bounds.right-panelRect.width-4),left<bounds.left+4&&(left=bounds.left+4),!placeAbove&&top+panelRect.height>bounds.bottom-4){const retryTop=anchor.top-panelRect.height-6;retryTop>=bounds.top+4&&(top=retryTop,placeAbove=!0)}setPanelStyle({top:Math.round(top),left:Math.round(left),position:"fixed",transform:"none","--emoji-placement":placeAbove?"above":"below"})},[state.visible,state.anchorRect]);const theme=document.body.classList.contains("light-theme")||document.querySelector(".App.light-theme")?"light":"dark";if(!state.visible)return null;const style=panelStyle||(state.anchorRect?{position:"fixed",top:state.anchorRect.bottom+8,left:state.anchorRect.left,opacity:0}:{top:"50%",left:"50%",transform:"translate(-50%, -50%)"});return(0,react_dom__WEBPACK_IMPORTED_MODULE_2__.createPortal)((0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)("div",{ref:panelRef,className:"emoji-picker-portal",style:(0,C_Users_nlaus_randomcode_firebase_chat_superchat_node_modules_babel_runtime_helpers_esm_objectSpread2_js__WEBPACK_IMPORTED_MODULE_0__.A)({zIndex:1600},style),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_4__.jsx)(emoji_picker_react__WEBPACK_IMPORTED_MODULE_3__.Ay,{onEmojiClick:emojiData=>{state.onSelect&&state.onSelect(emojiData),close()},autoFocusSearch:!0,theme})}),mountNode)}EmojiMenuSingleton.open=options=>{externalOpen?externalOpen(options):setTimeout(()=>externalOpen&&externalOpen(options),0)};const __WEBPACK_DEFAULT_EXPORT__={open:options=>EmojiMenuSingleton.open(options)}},"./src/stories/ChatInput.stories.jsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,WithReply:()=>WithReply,__namedExportsOrder:()=>__namedExportsOrder,default:()=>ChatInput_stories});var objectSpread2=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/objectSpread2.js"),react=__webpack_require__("./node_modules/react/index.js"),FirebaseContext=__webpack_require__("./src/services/FirebaseContext.js");let _audioCtx=null,_masterGain=null,_unlocked=!1;function createContext(){const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return null;const ctx=new AC;return _masterGain=ctx.createGain(),_masterGain.gain.value=.9,_masterGain.connect(ctx.destination),function setupUnlock(ctx){if(_unlocked)return;const unlock=()=>{if(!ctx)return;"suspended"===ctx.state&&ctx.resume().catch(()=>{});const buffer=ctx.createBuffer(1,1,22050),src=ctx.createBufferSource();src.buffer=buffer,src.connect(ctx.destination),src.start(0),_unlocked=!0,window.removeEventListener("pointerdown",unlock),window.removeEventListener("keydown",unlock),window.removeEventListener("touchstart",unlock)};window.addEventListener("pointerdown",unlock,{passive:!0}),window.addEventListener("keydown",unlock,{passive:!0}),window.addEventListener("touchstart",unlock,{passive:!0})}(ctx),ctx}function getCtx(){return _audioCtx||(_audioCtx=createContext(),_audioCtx)}const playNotificationSound=soundEnabled=>{if(soundEnabled)try{const audioContext=getCtx();if(!audioContext)return;"suspended"===audioContext.state&&audioContext.resume().catch(()=>{});const now=audioContext.currentTime,osc=audioContext.createOscillator(),gain=audioContext.createGain();osc.type="sine",osc.frequency.setValueAtTime(880,now),osc.frequency.exponentialRampToValueAtTime(540,now+.28),gain.gain.setValueAtTime(.001,now),gain.gain.exponentialRampToValueAtTime(.35,now+.01),gain.gain.exponentialRampToValueAtTime(8e-4,now+.5),osc.connect(gain),gain.connect(_masterGain||audioContext.destination),osc.start(now),osc.stop(now+.52)}catch(error){console.error("❌ Error playing sound:",error)}},playTypingSound=function(soundEnabled){let{multiple=!1,count=1,self=!1,withReverb=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(soundEnabled)try{const audioContext=getCtx();if(!audioContext)return;if("suspended"===audioContext.state&&audioContext.resume().catch(()=>{}),withReverb&&!_audioCtx._typingConvolver){const length=Math.floor(.28*audioContext.sampleRate),impulse=audioContext.createBuffer(2,length,audioContext.sampleRate);for(let ch=0;ch<2;ch++){const data=impulse.getChannelData(ch);for(let i=0;i<length;i++){const decay=Math.pow(1-i/length,2.8),rnd=.35*(2*Math.random()-1);data[i]=rnd*decay}}const convolver=audioContext.createConvolver();convolver.normalize=!0,convolver.buffer=impulse,_audioCtx._typingConvolver=convolver}const convolver=_audioCtx._typingConvolver||null,baseTime=audioContext.currentTime+.01,taps=self?1:multiple?4:3,loudness=self?[.42]:multiple?[1,.72,.55,.4]:[1,.68,.48],baseFreq=(self?320:360)+8*Math.min(count,5);for(let i=0;i<taps;i++){const osc=audioContext.createOscillator(),gain=audioContext.createGain(),hp=audioContext.createBiquadFilter(),pan=audioContext.createStereoPanner?audioContext.createStereoPanner():null;osc.type="triangle",hp.type="highpass",hp.frequency.setValueAtTime(180,baseTime);const startFreq=baseFreq+18*i+(12*Math.random()-6),endFreq=startFreq-70,start=baseTime+.085*i,end=start+.18;osc.frequency.setValueAtTime(startFreq,start),osc.frequency.exponentialRampToValueAtTime(Math.max(120,endFreq),end);const peak=.18*loudness[i];gain.gain.setValueAtTime(1e-4,start),gain.gain.exponentialRampToValueAtTime(peak,start+.008),gain.gain.exponentialRampToValueAtTime(1e-4,end);const drift=.02*Math.random()-.01,panVal=.7*Math.random()-.35;pan&&pan.pan.setValueAtTime(panVal,start);const dryGain=audioContext.createGain(),wetGain=audioContext.createGain();dryGain.gain.setValueAtTime(self?.55:.85,baseTime),wetGain.gain.setValueAtTime(withReverb?self?.12:.18:0,baseTime),osc.connect(gain),gain.connect(hp),pan?(hp.connect(pan),pan.connect(dryGain),withReverb&&convolver&&pan.connect(convolver)):(hp.connect(dryGain),withReverb&&convolver&&hp.connect(convolver)),dryGain.connect(_masterGain||audioContext.destination),withReverb&&convolver&&(convolver.connect(wetGain),wetGain.connect(_masterGain||audioContext.destination)),osc.start(start+drift),osc.stop(end+.02)}}catch(e){console.warn("⚠️ playTypingSound error:",e)}};var index_esm=__webpack_require__("./node_modules/firebase/firestore/dist/esm/index.esm.js");async function createTextMessage(_ref){let{firestore,text,user,getDisplayName,replyTo}=_ref;const messagesRef=(0,index_esm.rJ)(firestore,"messages"),{uid,photoURL,displayName}=user,data={text,createdAt:(0,index_esm.O5)(),uid,photoURL:photoURL||null,displayName:getDisplayName?getDisplayName(uid,displayName):displayName||"Anonymous",reactions:{}};return replyTo&&replyTo.id&&(data.replyTo=function normalizeReply(raw){if(!raw)return null;const clean=Object.fromEntries(Object.entries(raw).filter(_ref=>{let[_,v]=_ref;return void 0!==v}));return clean.type||(clean.type=clean.imageURL?"image":clean.text?"text":"meta"),clean}(replyTo)),(0,index_esm.gS)(messagesRef,data)}var esm_index_esm=__webpack_require__("./node_modules/firebase/storage/dist/esm/index.esm.js");function useImageMessage(_ref){let{storage,firestore,user,getDisplayName,soundEnabled,playSendSound}=_ref;const[selectedImage,setSelectedImage]=react.useState(null),[imagePreview,setImagePreview]=react.useState(null),[uploading,setUploading]=react.useState(!1),handleImageSelect=react.useCallback(file=>{var _file$type;if(!file||null===(_file$type=file.type)||void 0===_file$type||!_file$type.startsWith("image/"))return;setSelectedImage(file);const reader=new FileReader;reader.onload=e=>setImagePreview(e.target.result),reader.readAsDataURL(file)},[]),clearImage=react.useCallback(()=>{setSelectedImage(null),setImagePreview(null),setUploading(!1)},[]),sendImageMessage=react.useCallback(async()=>{if(selectedImage&&!uploading&&user){setUploading(!0);try{const compressed=await function compressImage(file){let{maxWidth=800,maxHeight=800,quality=.8}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((resolve,reject)=>{try{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image,objectUrl=URL.createObjectURL(file);img.onload=()=>{try{const scale=Math.min(1,maxWidth/img.width,maxHeight/img.height);canvas.width=Math.round(img.width*scale),canvas.height=Math.round(img.height*scale),ctx.drawImage(img,0,0,canvas.width,canvas.height),canvas.toBlob(blob=>{URL.revokeObjectURL(objectUrl),resolve(blob||file)},"image/jpeg",quality)}catch(err){URL.revokeObjectURL(objectUrl),console.error("compressImage processing error",err),resolve(file)}},img.onerror=()=>{URL.revokeObjectURL(objectUrl),resolve(file)},img.src=objectUrl}catch(outer){console.error("compressImage setup error",outer),resolve(file)}})}(selectedImage),url=await async function uploadImage(_ref){let{storage,file,uid}=_ref;if(!uid)return null;try{const filename="".concat(Date.now(),".jpg"),filePath="images/".concat(uid,"/").concat(filename),imageStorageRef=(0,esm_index_esm.KR)(storage,filePath);return await(0,esm_index_esm.D)(imageStorageRef,file),await(0,esm_index_esm.qk)(imageStorageRef)}catch(error){return console.error("uploadImage error:",error),null}}({storage,file:compressed,uid:user.uid});if(!url)throw new Error("Upload failed");await async function createImageMessage(_ref2){let{firestore,imageURL,user,getDisplayName}=_ref2;const messagesRef=(0,index_esm.rJ)(firestore,"messages"),{uid,photoURL,displayName}=user,data={imageURL,createdAt:(0,index_esm.O5)(),uid,photoURL:photoURL||null,displayName:getDisplayName?getDisplayName(uid,displayName):displayName||"Anonymous",reactions:{},type:"image"};return(0,index_esm.gS)(messagesRef,data)}({firestore,imageURL:url,user,getDisplayName}),clearImage(),soundEnabled&&playSendSound&&playSendSound()}catch(err){console.error("sendImageMessage error",err),alert("Failed to upload image: "+err.message),setUploading(!1)}}},[selectedImage,uploading,user,storage,firestore,getDisplayName,soundEnabled,playSendSound,clearImage]);return{selectedImage,imagePreview,uploading,handleImageSelect,clearImage,sendImageMessage,setSelectedImage,setImagePreview,setUploading}}var dist_esm_index_esm=__webpack_require__("./node_modules/firebase/database/dist/esm/index.esm.js");function useTypingPresence(_ref){let{rtdb,user,soundEnabled}=_ref;const lastSelfTapRef=react.useRef(0),lastTypingStateRef=react.useRef(!1),inactivityTimerRef=react.useRef(null),updateTyping=react.useCallback(isTyping=>{user&&lastTypingStateRef.current!==isTyping&&(lastTypingStateRef.current=isTyping,function setTyping(rtdb,_ref){let{uid,displayName,typing}=_ref;if(!uid)return;const userTypingRef=(0,dist_esm_index_esm.KR)(rtdb,"typing/".concat(uid));(0,dist_esm_index_esm.hZ)(userTypingRef,{typing:!!typing,displayName:displayName||"Anonymous",timestamp:(0,dist_esm_index_esm.O5)()})}(rtdb,{uid:user.uid,displayName:user.displayName,typing:isTyping}))},[rtdb,user]),handleInputActivity=react.useCallback(textLength=>{if(!user)return;if(updateTyping(textLength>0),function refreshPresence(rtdb,_ref2){let{uid}=_ref2;if(!uid)return;const presenceRef=(0,dist_esm_index_esm.KR)(rtdb,"presence/".concat(uid));(0,dist_esm_index_esm.yo)(presenceRef,{online:!0,lastSeen:Date.now()}).catch(()=>{})}(rtdb,{uid:user.uid}),inactivityTimerRef.current&&clearTimeout(inactivityTimerRef.current),inactivityTimerRef.current=setTimeout(()=>{updateTyping(!1)},6e3),!soundEnabled)return;const now=Date.now();1===textLength?now-lastSelfTapRef.current>800&&(playTypingSound(!0,{self:!0,withReverb:!0}),lastSelfTapRef.current=now):textLength>1&&now-lastSelfTapRef.current>6e3&&(playTypingSound(!0,{self:!0,withReverb:!0}),lastSelfTapRef.current=now)},[user,rtdb,soundEnabled,updateTyping]);return react.useEffect(()=>()=>{inactivityTimerRef.current&&clearTimeout(inactivityTimerRef.current)},[]),{handleInputActivity}}var EmojiMenu=__webpack_require__("./src/components/ChatInput/EmojiMenu.js");var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function ReplyPreview(_ref){let{replyingTo,onCancel,onJump}=_ref;return replyingTo?(0,jsx_runtime.jsxs)("div",{className:"reply-preview compact",children:[(0,jsx_runtime.jsxs)("button",{type:"button",className:"reply-preview-label only",onClick:()=>onJump&&replyingTo.id&&onJump(replyingTo.id),"aria-label":"Jump to original message from ".concat(replyingTo.displayName),title:"Jump to original message from ".concat(replyingTo.displayName),children:["Replying to ",replyingTo.displayName]}),(0,jsx_runtime.jsx)("button",{className:"reply-preview-close tiny",onClick:onCancel,type:"button","aria-label":"Cancel reply",title:"Cancel reply",children:(0,jsx_runtime.jsx)("span",{"aria-hidden":!0,children:"×"})})]}):null}function ImagePreviewModal(_ref){let{imagePreview,uploading,onSend,onCancel}=_ref;return imagePreview?(0,jsx_runtime.jsx)("div",{className:"image-preview-container",role:"dialog","aria-modal":"true","aria-label":"Image preview",children:(0,jsx_runtime.jsxs)("div",{className:"image-preview",children:[(0,jsx_runtime.jsx)("img",{src:imagePreview,alt:"Preview"}),(0,jsx_runtime.jsxs)("div",{className:"image-preview-actions",children:[(0,jsx_runtime.jsx)("button",{onClick:onSend,disabled:uploading,className:"send-image-btn",children:uploading?"Uploading...":"Send Image"}),(0,jsx_runtime.jsx)("button",{onClick:onCancel,className:"cancel-image-btn",children:"Cancel"})]})]})}):null}ReplyPreview.__docgenInfo={description:"",methods:[],displayName:"ReplyPreview"},ImagePreviewModal.__docgenInfo={description:"",methods:[],displayName:"ImagePreviewModal"};var fa6=__webpack_require__("./node_modules/react-icons/fa6/index.mjs"),vsc=__webpack_require__("./node_modules/react-icons/vsc/index.mjs");function MessageBar(_ref){let{text,onChange,onKeyDown,onPickEmoji,onTriggerFile,emojiOpen,emojiButtonRef,textareaRef}=_ref;return(0,jsx_runtime.jsxs)("div",{className:"message-bar",role:"group","aria-label":"Message input",children:[(0,jsx_runtime.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var _e$target$files;const file=null===(_e$target$files=e.target.files)||void 0===_e$target$files?void 0:_e$target$files[0];file&&onTriggerFile(file)},style:{display:"none"},id:"image-upload"}),(0,jsx_runtime.jsx)("button",{type:"button",className:"bar-icon-btn","aria-label":"Upload image","data-tip":"Upload image",onClick:()=>{const fileInput=document.getElementById("image-upload");fileInput&&fileInput.click()},children:(0,jsx_runtime.jsx)(fa6.OiG,{size:18,"aria-hidden":"true"})}),(0,jsx_runtime.jsx)("textarea",{ref:textareaRef,value:text,onChange:e=>onChange(e.target.value),onKeyDown,placeholder:"Send a message",className:"message-input","aria-label":"Message text",rows:1,spellCheck:!0}),(0,jsx_runtime.jsx)("button",{type:"button",ref:emojiButtonRef,className:"bar-icon-btn ".concat(emojiOpen?"emoji-active":""),"aria-label":"Add emoji","data-tip":"Add emoji",onClick:onPickEmoji,children:(0,jsx_runtime.jsx)(vsc.oJZ,{size:20,"aria-hidden":"true"})})]})}function ChatInput_ChatInput(_ref){let{getDisplayName,replyingTo,setReplyingTo,soundEnabled,selectedImage:liftedSelectedImage,setSelectedImage:setLiftedSelectedImage,imagePreview:liftedImagePreview,setImagePreview:setLiftedImagePreview,uploading:liftedUploading,setUploading:setLiftedUploading,forceScrollBottom}=_ref;const{auth,firestore,rtdb,storage}=(0,FirebaseContext.D3)(),user=auth.currentUser,[text,setText]=react.useState(""),imageHook=useImageMessage({storage,firestore,user,getDisplayName,soundEnabled,playSendSound:()=>playNotificationSound(!0)});react.useEffect(()=>{liftedSelectedImage&&!imageHook.selectedImage&&imageHook.setSelectedImage(liftedSelectedImage),liftedImagePreview&&!imageHook.imagePreview&&imageHook.setImagePreview(liftedImagePreview),"boolean"==typeof liftedUploading&&liftedUploading!==imageHook.uploading&&imageHook.setUploading(liftedUploading)},[liftedSelectedImage,liftedImagePreview,liftedUploading,imageHook.selectedImage,imageHook.imagePreview,imageHook.uploading]),react.useEffect(()=>{setLiftedSelectedImage&&setLiftedSelectedImage(imageHook.selectedImage),setLiftedImagePreview&&setLiftedImagePreview(imageHook.imagePreview),setLiftedUploading&&setLiftedUploading(imageHook.uploading)},[setLiftedSelectedImage,setLiftedImagePreview,setLiftedUploading,imageHook.selectedImage,imageHook.imagePreview,imageHook.uploading]);const{handleInputActivity}=useTypingPresence({rtdb,user,soundEnabled}),{open:emojiOpen,toggle:toggleEmoji,buttonRef:emojiButtonRef,setOnSelect}=function useEmojiPicker(){const[open,setOpen]=react.useState(!1),buttonRef=react.useRef(null),onSelect=react.useRef(null),openMenu=react.useCallback(()=>{if(open)return;const anchorRect=buttonRef.current?buttonRef.current.getBoundingClientRect():null;EmojiMenu.Ay.open({anchorRect,onSelect:emojiData=>{onSelect.current&&onSelect.current(emojiData)},onClose:()=>setOpen(!1)}),setOpen(!0)},[open]),closeMenu=react.useCallback(()=>{open&&setOpen(!1)},[open]),toggle=react.useCallback(()=>{open?closeMenu():openMenu()},[open,closeMenu,openMenu]),setOnSelect=react.useCallback(handler=>{onSelect.current=handler},[]);return{open,toggle,buttonRef,setOnSelect}}(),inputRef=react.useRef(null);react.useEffect(()=>{setOnSelect(emojiData=>{const emoji=(null==emojiData?void 0:emojiData.emoji)||"";emoji&&(setText(v=>v+emoji),inputRef.current&&inputRef.current.focus())})},[setOnSelect]);const sendText=async()=>{if(user&&text.trim())try{await createTextMessage({firestore,text,user,getDisplayName,replyTo:replyingTo}),setText(""),setReplyingTo(null),soundEnabled&&playNotificationSound(!0),forceScrollBottom&&setTimeout(()=>forceScrollBottom(),10)}catch(err){console.error("Error sending message",err),alert("Failed to send message: "+err.message)}};react.useEffect(()=>{const handler=e=>{e.detail&&e.detail.text&&(setText(e.detail.text),requestAnimationFrame(()=>{if(inputRef.current){const val=e.detail.text;inputRef.current.focus(),inputRef.current.selectionStart=inputRef.current.selectionEnd=val.length}}))};return document.addEventListener("chat:prefill",handler),()=>document.removeEventListener("chat:prefill",handler)},[]),react.useEffect(()=>{const handleShortcut=e=>{const tag=e.target&&e.target.tagName?e.target.tagName.toLowerCase():"";if("input"===tag||"textarea"===tag||e.target.isContentEditable)return;if((e.ctrlKey||e.metaKey)&&("i"===e.key||"I"===e.key)){e.preventDefault();const input=document.getElementById("image-upload");input&&input.click()}};return document.addEventListener("keydown",handleShortcut),()=>document.removeEventListener("keydown",handleShortcut)},[]);return(0,jsx_runtime.jsxs)("div",{className:"chat-input-area",children:[(0,jsx_runtime.jsx)(ImagePreviewModal,{imagePreview:imageHook.imagePreview,uploading:imageHook.uploading,onSend:imageHook.sendImageMessage,onCancel:imageHook.clearImage}),(0,jsx_runtime.jsx)(ReplyPreview,{replyingTo,onCancel:()=>setReplyingTo(null),onJump:id=>{const selector='[data-message-id="'.concat(id,'"]'),el=document.querySelector(selector);el&&(el.scrollIntoView({behavior:"smooth",block:"center"}),el.classList.contains("reply-target")||(el.classList.add("reply-target"),setTimeout(()=>el.classList.remove("reply-target"),3e3)))}}),(0,jsx_runtime.jsxs)("form",{onSubmit:e=>{e.preventDefault(),sendText()},className:"message-form",children:[(0,jsx_runtime.jsx)(MessageBar,{text,onChange:val=>{setText(val),handleInputActivity(val.length)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendText())},onPickEmoji:toggleEmoji,emojiOpen,emojiButtonRef,onTriggerFile:imageHook.handleImageSelect,textareaRef:inputRef}),(0,jsx_runtime.jsx)("button",{type:"submit",disabled:!text,className:"send-btn","aria-label":"Send message",children:"➤"})]})]})}MessageBar.__docgenInfo={description:"",methods:[],displayName:"MessageBar"};const components_ChatInput_ChatInput=ChatInput_ChatInput;ChatInput_ChatInput.__docgenInfo={description:"",methods:[],displayName:"ChatInput"};const ChatInput_stories={title:"Chat/ChatInput",component:components_ChatInput_ChatInput,args:{getDisplayName:(uid,name)=>name||"User",replyingTo:null,setReplyingTo:()=>{},soundEnabled:!1,forceScrollBottom:()=>{}},parameters:{chromatic:{disableSnapshot:!1}}},Default=args=>(0,jsx_runtime.jsx)(components_ChatInput_ChatInput,(0,objectSpread2.A)({},args)),WithReply=args=>(0,jsx_runtime.jsx)(components_ChatInput_ChatInput,(0,objectSpread2.A)((0,objectSpread2.A)({},args),{},{replyingTo:{id:"m1",displayName:"Bob",text:"Original message"}})),__namedExportsOrder=["Default","WithReply"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:"args => <ChatInput {...args} />",...Default.parameters?.docs?.source}}},WithReply.parameters={...WithReply.parameters,docs:{...WithReply.parameters?.docs,source:{originalSource:"args => <ChatInput {...args} replyingTo={{\n  id: 'm1',\n  displayName: 'Bob',\n  text: 'Original message'\n}} />",...WithReply.parameters?.docs?.source}}}}}]);