name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'LICENSE'
      - '.github/labeler.yml'
      - '.github/workflows/stale.yml'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'LICENSE'

permissions:
  contents: read
  id-token: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine diff range
        id: range
        run: |
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            echo "range=HEAD^ HEAD" >> $GITHUB_OUTPUT
          else
            git fetch --depth=2 origin main || true
            echo "range=origin/main...HEAD" >> $GITHUB_OUTPUT
      - name: Detect changed areas
        id: diff
        run: |
          RANGE="${{ steps.range.outputs.range }}"
          if git diff --name-only $RANGE | grep '^functions/' >/dev/null 2>&1; then
            echo "functions_changed=true" >> $GITHUB_OUTPUT
          else
            echo "functions_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install root deps
        run: npm ci

      - name: Install functions deps (only if changed)
        if: steps.diff.outputs.functions_changed == 'true'
        run: (cd functions && npm ci)

      - name: Lint (PR)
        if: github.event_name == 'pull_request'
        run: npm run lint

      - name: Tests (fast, PR)
        if: github.event_name == 'pull_request'
        run: npm run test:changed

      - name: Tests (full + coverage on main push)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: npm run test:ci

      - name: Build app (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          REACT_APP_FIREBASE_API_KEY: ${{ vars.REACT_APP_FIREBASE_API_KEY }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ vars.REACT_APP_FIREBASE_AUTH_DOMAIN }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ vars.REACT_APP_FIREBASE_STORAGE_BUCKET }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
          REACT_APP_FIREBASE_APP_ID: ${{ vars.REACT_APP_FIREBASE_APP_ID }}
          REACT_APP_FIREBASE_DATABASE_URL: ${{ vars.REACT_APP_FIREBASE_DATABASE_URL }}
        run: npm run build

      - name: Upload build artifact (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build
          if-no-files-found: error

      - name: Upload coverage to Codecov (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          if [ ! -f coverage/lcov.info ]; then echo "No coverage lcov.info found; skipping"; exit 0; fi
          npx codecov -f coverage/lcov.info || echo "Codecov upload failed (non-blocking)"
